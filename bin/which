#!/usr/bin/env php
<?php
declare(strict_types=1);

use EventLoop\{EventLoop};
use Rx\{Observable, Scheduler};
use Rx\Scheduler\{EventLoopScheduler};
use Which\{Application};

/**
 * Application entry point.
 * @return Observable Completes when the program is terminated.
 */
function main(): Observable {
  @cli_set_process_title('Which.php');

  Scheduler::setDefaultFactory(function() {
    return new EventLoopScheduler(EventLoop::getLoop());
  });

  return (new Application)->run()
    ->catch(function() {
      exit(1);
    })
    ->do(function($status) {
      exit($status);
    });
}

// Start the application.
$fileInfo = new SplFileInfo(__DIR__.'/../../../autoload.php');
require_once $fileInfo->isFile() ? $fileInfo->getPathname() : __DIR__.'/../vendor/autoload.php';

main()->subscribe(null, function($error) {
  echo $error, PHP_EOL;
  exit(2);
});
